i:.'0:0
s:-1_9999,
d:{w:(0&=71).[;;:;9999]/x#i
://{y|x&1+(|s@|:)'[x]&(|s@|:)[x]&s'[x]&s x}[;w]/.[9999|w;0 0;:;0]}
/i@-1+(9999>d@)(1+)/0

bs:{[f;l;r]
$[1=r-l;l
$[f h:-2!l+r;o[f;l;h];o[f;h;r]]]}
`0:","/$i@bs[~9999>d@;0;#i]
