i:0:0
s:~i="#"
/ ESWN
h:-1_0w,
D:_{x&(1000+|4#3({x&z}.)':x)&(1+(h';h;(|h@|:)';|h@|:)@'x)%\:s}/.[4#,{0w}''i;0,/+&i="S";:;0]
(&/D).,/&i="E"
